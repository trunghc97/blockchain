<div class="container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <mat-icon>description</mat-icon>
        Trạng thái hợp đồng
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="loading-spinner" *ngIf="loading">
        <mat-spinner></mat-spinner>
      </div>

      <div *ngIf="!loading">
        <!-- Search and Filter -->
        <div class="filters">
          <mat-form-field appearance="outline">
            <mat-label>Tìm kiếm</mat-label>
            <input matInput (keyup)="applyFilter($event)" placeholder="Nhập mã hợp đồng, mô tả...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Trạng thái</mat-label>
            <mat-select (selectionChange)="filterByStatus($event)">
              <mat-option value="">Tất cả</mat-option>
              <mat-option value="PENDING">Đang chờ</mat-option>
              <mat-option value="APPROVED">Đã duyệt</mat-option>
              <mat-option value="REJECTED">Từ chối</mat-option>
              <mat-option value="COMPLETED">Hoàn thành</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Contracts Table -->
        <div class="contracts-table">
          <div *ngFor="let contract of filteredContracts; trackBy: trackByContractId" class="contract-group">
            <!-- Main Contract Row -->
            <div class="contract-main-row" (click)="toggleContractDetails(contract.contractId)">
              <div class="contract-info">
                <div class="contract-header">
                  <strong>{{contract.contractId}}</strong>
                  <span class="contract-description">{{contract.description}}</span>
                </div>
                <div class="contract-meta">
                  <span class="total-amount">Tổng: {{formatAmount(contract.totalAmount || 0)}}</span>
                  <span [ngClass]="'status-chip status-' + contract.status.toLowerCase()">
                    {{contract.status}}
                  </span>
                </div>
              </div>

              <div class="contract-actions">
                <button mat-icon-button [matTooltip]="'Xem Ledger'" [routerLink]="['/ledger']" [queryParams]="{contractId: contract.contractId}">
                  <mat-icon>account_balance</mat-icon>
                </button>
                <mat-icon class="expand-icon" [class.expanded]="expandedContracts[contract.contractId]">
                  {{ expandedContracts[contract.contractId] ? 'expand_less' : 'expand_more' }}
                </mat-icon>
              </div>
            </div>

            <!-- Supplier Details (Collapsible) -->
            <div class="supplier-details" *ngIf="expandedContracts[contract.contractId]">
              <div class="supplier-header">
                <h4>Danh sách nhà cung cấp</h4>
              </div>

              <!-- Supplier Table Header -->
              <div class="supplier-table-header">
                <div class="supplier-name-header">Tên nhà cung cấp</div>
                <div class="supplier-amount-header">Số tiền</div>
                <div class="supplier-status-header">Trạng thái</div>
                <div class="supplier-actions-header">Thao tác</div>
              </div>

              <div *ngFor="let supplier of contract.suppliers; let i = index" class="supplier-row">
                <div class="supplier-name">{{supplier.name}}</div>
                <div class="supplier-amount">{{formatAmount(supplier.amount || 0)}}</div>
                <div class="supplier-status">
                  <span [ngClass]="'status-chip status-' + getSupplierStatus(supplier).toLowerCase()">
                    {{getSupplierStatus(supplier)}}
                  </span>
                </div>
                <div class="supplier-actions">
                  <div *ngIf="supplier.status === 'PENDING' && canApproveSupplier(supplier); else cannotApprove">
                    <button mat-raised-button color="primary" size="small"
                            (click)="approveSupplier(contract, supplier)" [disabled]="approvingSuppliers[supplier.supplierId]">
                      <mat-spinner diameter="16" *ngIf="approvingSuppliers[supplier.supplierId]"></mat-spinner>
                      <span *ngIf="!approvingSuppliers[supplier.supplierId]">Duyệt</span>
                    </button>
                    <button mat-button color="warn" size="small"
                            (click)="rejectSupplier(contract, supplier)" [disabled]="approvingSuppliers[supplier.supplierId]">
                      Từ chối
                    </button>
                  </div>
                  <ng-template #cannotApprove>
                    <span class="text-muted">Đã xử lý</span>
                  </ng-template>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="no-data" *ngIf="filteredContracts.length === 0">
          <mat-icon>inbox</mat-icon>
          <p>Chưa có hợp đồng nào</p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>